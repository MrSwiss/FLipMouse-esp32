<html>
<head>
    <title>FlipMouse WebGUI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link rel="stylesheet" href="css/tabby.min.css">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="stylesheet" href="css/rangeslider.css">
    <script src="lib/lquery.js"></script>
    <script src="lib/areCommunicatorLight.js"></script>
    <script src="lib/flipMouseCommunicator.js"></script>
    <script src="lib/tabby.min.js"></script>
    <script src="lib/dom-i18n.min.js"></script>
</head>
<body>
<div id="content">
    <div class="row">
        <h1 class="nine columns" i18n>FLipMouse Web Configuration // FLipMouse Webkonfiguration</h1>
        <div class="three columns">
            <label class="row u-full-width" for="selectSlots" i18n>Select Slot // Slot auswählen</label>
            <select id="selectSlots" class="row u-full-width" onchange="selectSlot(this)">
            </select>
        </div>
    </div>
    <div class="row hide-mobile" style="margin-bottom: 1.5em"></div>

    <div data-tabs class="row" id="tabMenu">
        <div class="four columns hide-mobile"><a onclick="toTab(this.href)" class="button button-primary" data-tab href="#tabBasic"
                                     class="ui-btn-active" i18n>Basic Setup // Basis-Konfiguration</a></div>
        <div class="four columns hide-mobile"><a onclick="toTab(this.href)" class="button button-primary" data-tab href="#tabPuff" i18n>Sip and Puff // Saug-Blassteuerung</a></div>
        <div class="four columns hide-mobile"><a onclick="toTab(this.href)" class="button button-primary" data-tab
                                     href="#tabActions">Learn Actions</a></div>
        <div class="show-mobile"><a id="toNavLink" onclick="toNav()" class="button button-primary" data-tab href="#tabNav" i18n>&#x2630; Menu // &#x2630; Menü</a></div>
        <div class="show-mobile"><a id="toNavBackLink" style="display: none" onclick="toNavBack()" class="button button-primary" i18n>&#8592; Back // &#8592; Zurück</a></div>
    </div>
    <div data-tabs-content>
        <div data-tabs-pane class="tabs-pane" id="tabNav">
            <div id="tabNavContainer" class="row"></div>
        </div>
        <div data-tabs-pane class="tabs-pane" id="tabBasic">
            <div id="basic-SENSITIVITY-single">
                <label for="SENSITIVITY" i18n>Sensitivity: // Sensitivität:</label>
                <a class="u-pull-right" href="javascript:toggleShowXY('SENSITIVITY')" i18n>show x/y separately // zeige x/y getrennt</a>
                <div class="row">
                    <span id="SENSITIVITY_VAL" class="text-center one column">0</span>
                    <input type="range" oninput="basicSliderChanged(event)" onchange="basicSliderChanged(event)"
                           id="SENSITIVITY" min="0" max="255" class="eleven columns">
                </div>
            </div>
            <div id="basic-SENSITIVITY-xy" style="display: none">
                <label for="SENSITIVITY_X" i18n>Horizontal Sensitivity: // Sensitivität horizontal:</label>
                <a class="u-pull-right" href="javascript:toggleShowXY('SENSITIVITY')" i18n>hide separate x/y // zeige  x/y gemeinsam</a>
                <div class="row">
                    <span id="SENSITIVITY_X_VAL" class="text-center one column">0</span>
                    <input type="range" oninput="basicSliderChanged(event)" onchange="basicSliderChanged(event)"
                           id="SENSITIVITY_X" min="0" max="255" class="eleven columns">
                </div>
                <label for="SENSITIVITY_Y" i18n>Vertical Sensitivity: // Sensitivität vertikal:</label>
                <div class="row">
                    <span id="SENSITIVITY_Y_VAL" class="text-center one column">0</span>
                    <input type="range" oninput="basicSliderChanged(event)" onchange="basicSliderChanged(event)"
                           id="SENSITIVITY_Y" min="0" max="255" class="eleven columns">
                </div>
            </div>

            <br/>
            <div class="row">
                <div class="six columns">
                    <div class="relative center-div cursorPosWrapper">
                        <div id="orientationSign" class="back-layer full-height full-width" style="transform: rotate(270deg);">
                            <div class="back-layer" style="top:100%; left: 35%; width: 30%; height: 10%; background-color: black; z-index: 2"></div>
                        </div>
                        <div id="deadZonePos" class="back-layer color-lightcyan"
                             style="top: 40%; left: 40%; height: 20%; width: 20%;"></div>
                        <div class="back-layer"
                             style="left: 50%; height: 100%; border-right-style: solid; border-right-width: thin;"></div>
                        <div class="back-layer"
                             style="top: 50%; width: 100%; border-bottom-style: solid; border-bottom-width: thin;"></div>
                        <button onclick="cursorPosZoomReset();" class="zoombutton" style="top: 55%;" title="Reset Zoom">&#8634;</button>
                        <div id="cursorPosVal" class="back-layer" style="top: 40%;">110</div>
                        <div id="cursorPos" class="back-layer" style="top: 50%; left: 50%;">
                            <div class="back-layer" id="circle"></div>
                        </div>
                    </div>
                </div>
                <div class="five columns">
                    <button onclick="flipActionThenToggle(flip.calibrate, ['#basic-button-calibrate', '#basic-button-calibrating'])">
                        <span i18n id="basic-button-calibrate">Calibrate middle position // Mittelposition kalibrieren</span>
                        <span id="basic-button-calibrating" style="display: none;" i18n>Calibrating... // wird kalibriert...</span>
                    </button>
                    <button onclick="flipActionThenToggle(flip.rotate, ['#basic-button-rotate', '#basic-button-rotating'])">
                        <span i18n id="basic-button-rotate">&#x21bb; Rotate right // &#x21bb; Nach rechts drehen</span>
                        <span id="basic-button-rotating" style="display: none;" i18n>Rotating... // wird gedreht...</span>
                    </button>
                </div>
            </div>

            <br/>
            <div id="basic-DEADZONE-single">
                <label for="DEADZONE">Deadzone:</label>
                <a class="u-pull-right" href="javascript:toggleShowXY('DEADZONE')" i18n>show x/y separately // zeige x/y getrennt</a>
                <div class="row">
                    <span id="DEADZONE_VAL" class="text-center one column">0</span>
                    <input type="range" oninput="basicSliderChanged(event)" onchange="basicSliderChanged(event)"
                           id="DEADZONE" min="0" max="650" class="eleven columns">
                </div>
            </div>
            <div id="basic-DEADZONE-xy" style="display: none">
                <label for="DEADZONE_X">Horizontal Deadzone:</label>
                <a class="u-pull-right" href="javascript:toggleShowXY('DEADZONE')" i18n>hide separate x/y // zeige x/y gemeinsam</a>
                <div class="row">
                    <span id="DEADZONE_X_VAL" class="text-center one column">0</span>
                    <input type="range" oninput="basicSliderChanged(event)" onchange="basicSliderChanged(event)"
                           id="DEADZONE_X" min="0" max="650" class="eleven columns">
                </div>
                <label for="DEADZONE_Y">Vertical Deadzone:</label>
                <div class="row">
                    <span id="DEADZONE_Y_VAL" class="text-center one column">0</span>
                    <input type="range" oninput="basicSliderChanged(event)" onchange="basicSliderChanged(event)"
                           id="DEADZONE_Y" min="0" max="650" class="eleven columns">
                </div>
            </div>


            <br/>
            <br/>
            <div class="row">
                <button id="basic-button" onclick="flipActionThenToggle(flip.save, ['#basic-button-normal', '#basic-button-saving'], '#save-basic-value-bar')" class="one-third" style="position: relative;">
                    <div id="save-basic-value-bar" class="value-bar color-lightercyan" style="width: 0%;"></div>
                    <div id="basic-button-normal" i18n>Save // Speichern</div>
                    <div id="basic-button-saving" style="display: none;" i18n>Saving... // Wird
                        gespeichert...
                    </div>
                </button>
            </div>
        </div>
        <div data-tabs-pane class="tabs-pane" id="tabPuff">

            <div id="tab-puff-container" class="relative">

                <div class="row back-layer full-height full-width">
                    <div class="two columns"><span style="font-size: 1px; color: transparent">_</span></div>
                    <div class="ten columns full-height relative">
                        <div id="guide-current" class="back-layer full-height border-right-gray"
                             style="width: 50%;"></div>
                        <div id="guide-max" class="back-layer full-height border-right-red" style="width: 50%;"></div>
                        <div id="guide-min" class="back-layer full-height border-right-blue" style="width: 50%;"></div>
                    </div>
                </div>

                <br/>
                <label for="SIP_THRESHOLD" i18n>Sip Threshold: // Schwellenwert Saugen:</label>
                <div class="row">
                    <span id="SIP_THRESHOLD_VAL" class="text-center two columns">0</span>
                    <input type="range" oninput="sipSliderChanged(this)" onchange="sipSliderChanged(this)"
                           id="SIP_THRESHOLD" min="0" max="1023" class="ten columns"/>
                </div>
                <label for="SIP_STRONG_THRESHOLD" i18n>Strong Sip Threshold: // Schwellenwert Saugen
                    stark:</label>
                <div class="row">
                    <span id="SIP_STRONG_THRESHOLD_VAL" class="text-center two columns">0</span>
                    <input type="range" oninput="sipSliderChanged(this)" onchange="sipSliderChanged(this)"
                           id="SIP_STRONG_THRESHOLD" min="0" max="1023" class="ten columns"/>
                </div>

                <br/>
                <label for="value-bar-wrapper" i18n>Live values: // Aktuelle Werte:</label>
                <div class="row">
                    <div id="value-bar-wrapper" class="text-center two columns">
                        <span i18n>current: // aktuell:</span><span id="currentValue">0</span>,
                        <span>max:</span><span id="maxValue">0</span>,
                        <span>min:</span><span id="minValue">-1</span></div>
                    <div class="ten columns"
                         style="position:relative; height: 2em; border-style: solid; border-width: thin; background-color: transparent">
                        <div id="sippuff-value-bar" class="value-bar" style="width: 50%;"></div>
                    </div>
                </div>

                <br/>
                <br/>
                <label for="PUFF_THRESHOLD" i18n>Puff Threshold: // Schwellenwert Blasen:</label>
                <div class="row">
                    <span id="PUFF_THRESHOLD_VAL" class="text-center two columns">0</span>
                    <input type="range" oninput="sipSliderChanged(this)" onchange="sipSliderChanged(this)"
                           id="PUFF_THRESHOLD" min="0" max="1023" class="ten columns">
                </div>
                <label for="PUFF_STRONG_THRESHOLD" i18n>Strong Puff Threshold: // Schwellenwert Blasen
                    stark:</label>
                <div class="row">
                    <span id="PUFF_STRONG_THRESHOLD_VAL" class="text-center two columns">0</span>
                    <input type="range" oninput="sipSliderChanged(this)" onchange="sipSliderChanged(this)"
                           id="PUFF_STRONG_THRESHOLD" min="0" max="1023" class="ten columns">
                </div>
            </div>

            <br/>
            <br/>
            <button id="sip-puff-button" onclick="flipActionThenToggle(flip.save, ['#sip-puff-button-normal', '#sip-puff-button-saving'], '#save-sip-value-bar')" class="u-full-width" style="position: relative;">
                <div id="save-sip-value-bar" class="value-bar color-lightercyan" style="width: 0%;"></div>
                <div id="sip-puff-button-normal" style="position: relative" i18n>Save // Speichern</div>
                <div id="sip-puff-button-saving" style="display: none" i18n>Saving... // Wird
                    gespeichert...
                </div>

            </button>
        </div>
        <div data-tabs-pane class="tabs-pane" id="tabActions">
            <div class="empty-separator"></div>

            <label for="action-1">Select an action:</label>
            <select id="actioncommand">
                <option selected="selected" value="CL">Click Left</option>
                <option value="CR">Click Right</option>
                <option value="PL">Press (Hold) Left</option>
                <option value="KW">Write Keyboard</option>
            </select>
            <label for="action-2">additional paramters (text or value):</label>
            <input type="text" data-clear-btn="true" name="actionparameter" id="actionparameter" value="">
            <div class="empty-separator"></div>
            <input type="button" id="action-button" value="Learn Gesture">
        </div>
    </div>
</div>

<script>
    window.onload = function () {
        tabby.init();
        domI18n({
            selector: '[i18n]',
            separator: ' // ',
            languages: ['en', 'de']
        });
        var flip = new FlipMouse(function (config) {
            initWithConfig(config);
            initSlots();
            toTab(getCurrentTabId());
        });
        window.flip = flip;
    };

    function initWithConfig(config) {
        console.log('applying config:');
        console.log(config);
        setSliderValue(flip.SENSITIVITY_X, config[flip.SENSITIVITY_X]);
        setSliderValue(flip.SENSITIVITY_Y, config[flip.SENSITIVITY_Y]);
        setSliderValue('SENSITIVITY', config[flip.SENSITIVITY_X]);
        setSliderValue(flip.DEADZONE_X, config[flip.DEADZONE_X]);
        setSliderValue(flip.DEADZONE_Y, config[flip.DEADZONE_Y]);
        setSliderValue('DEADZONE', config[flip.DEADZONE_X]);
        setSliderValue(flip.SIP_THRESHOLD, config[flip.SIP_THRESHOLD]);
        setSliderValue(flip.SIP_STRONG_THRESHOLD, config[flip.SIP_STRONG_THRESHOLD]);
        setSliderValue(flip.PUFF_THRESHOLD, config[flip.PUFF_THRESHOLD]);
        setSliderValue(flip.PUFF_STRONG_THRESHOLD, config[flip.PUFF_STRONG_THRESHOLD]);

        if (config[flip.SENSITIVITY_X] != config[flip.SENSITIVITY_Y]) {
            toggleShowXY('SENSITIVITY');
        }
        if (config[flip.DEADZONE_X] != config[flip.DEADZONE_Y]) {
            toggleShowXY('DEADZONE');
        }
    }

    function initSlots() {
        var slots = flip.getSlots();
        slots.forEach(function (slot) {
            var option = document.createElement("option");
            option.value = slot;
            option.innerHTML = slot;
            L('#selectSlots').appendChild(option);
        });
    }

    function selectSlot(select) {
        var config = flip.setSlot(select.value);
        initWithConfig(config);
    }

    function basicSliderChanged(evt) {
        var id = evt.currentTarget.id;
        var val = evt.currentTarget.value;
        if(id.indexOf('_X') == -1 && id.indexOf('_Y') == -1) {
            //slider for x/y synchronous was moved
            L('#' + id + '_VAL').innerHTML = val;
            setSliderValue(id + '_X', val);
            setSliderValue(id + '_Y', val);
            flip.setValue(id + '_X', val);
            flip.setValue(id + '_Y', val);
        } else {
            setSliderValue(id, val, true);
            flip.setValue(id, val);
        }
    }

    function sipSliderChanged(input) {
        var old = flip.getConfig([input.id]);
        var new1 = parseInt(input.value);
        var cur = flip.getLiveData([flip.LIVE_PRESSURE]);

        //only move slider if sip thresholds are below and puff thresholds are above the current live value and if strong-values are below/above normal values
        if ((input.id == flip.SIP_THRESHOLD && new1 < cur && new1 > flip.getConfig(flip.SIP_STRONG_THRESHOLD)) ||
            (input.id == flip.SIP_STRONG_THRESHOLD && new1 < cur && new1 < flip.getConfig(flip.SIP_THRESHOLD)) ||
            (input.id == flip.PUFF_THRESHOLD && new1 > cur && new1 < flip.getConfig(flip.PUFF_STRONG_THRESHOLD)) ||
            (input.id == flip.PUFF_STRONG_THRESHOLD && new1 > cur && new1 > flip.getConfig(flip.PUFF_THRESHOLD))) {

            setSliderValue(input.id, new1, true);
            flip.setValue(input.id, new1);
        } else {
            setSliderValue(input.id, old);
        }
    }

    function setSliderValue(constant, value, dontSetSlider) {
        L('#' + constant + '_VAL').innerHTML = value;
        if (!dontSetSlider) {
            L('#' + constant).value = value;
        }
    }

    function toggleShowXY (constant) {
        var xVal = flip.getConfig(constant + '_X');
        var toSingle = L.isVisible('#basic-' + constant + '-xy');
        L.toggle('#basic-' + constant + '-single', '#basic-' + constant + '-xy');
        if(toSingle) {
            flip.setValue(constant + '_Y', xVal);
            L('#' + constant + '_VAL').innerHTML = xVal;
            L('#' + constant).value = xVal;
        } else {
            setSliderValue(constant, xVal);
        }
    }

    function flipActionThenToggle(actionFunction, toggleElementList, progressBarId) {
        var maxProgress = 0;
        var stopProgressBar = false;
        L.toggle.apply(null, toggleElementList);
        actionFunction(progressHandler).then(function () {
            progressHandler(100, 100);
            setTimeout(function () {
                stopProgressBar = true;
                L(progressBarId).style = 'width: 0%;';
            }, 500);
            L.toggle.apply(null, toggleElementList);
        }, function () {
            stopProgressBar = true;
        });

        function progressHandler(progress, timeConstant) {
            var startTime = L.getMs();
            timeConstant = timeConstant || 1000;
            if (progressBarId) {
                updateProgressBar(maxProgress);
            }

            function updateProgressBar(oldPrg) {
                setTimeout(function () {
                    var t = L.getMs() - startTime;
                    var p = (progress - oldPrg) * (1 - Math.exp(-t / timeConstant)) + oldPrg;
                    if(p > maxProgress && !stopProgressBar) {
                        maxProgress = p;
                        L(progressBarId).style = 'width: ' + p + '%;';
                        updateProgressBar(oldPrg);
                    }
                }, 50);
            }
        }
    }

    function toTab(tabId) {
        tabId = parseTabId(tabId);
        if(!tabId) {
            tabId = '#tabBasic';
        }
        tabby.toggleTab(tabId);
        L.setVisible('#toNavLink');
        L.setVisible('#toNavBackLink', false);
        if (tabId.indexOf('#tabBasic') > -1) {
            toBasic();
        } else if (tabId.indexOf('#tabPuff') > -1) {
            toSipPuff();
        } else if (tabId.indexOf('#tabActions') > -1) {
            toActionLearn();
        }  else if (tabId.indexOf('#tabNav') > -1) {
            toNav();
        }
    }
    
    function toBasic() {
        flip.startLiveValueListener(cursorPosValueHandler);
    }

    function toSipPuff() {
        flip.startLiveValueListener(sipPuffValueHandler);
    }

    function toActionLearn() {
        flip.stopLiveValueListener();
    }

    function toNav() {
        tabby.toggleTab('#tabNav');
        L.toggle('#toNavLink', '#toNavBackLink');
        window.lastNav = getCurrentTabId();

        var tabNav = L('#tabNavContainer');
        if(tabNav.hasChildNodes()) {
            return;
        }
        var navItems = L('#tabMenu').children;
        for (var i = 0; i < navItems.length-2; i++) {
            var clone = navItems[i].cloneNode(true);
            clone.className = '';
            tabNav.appendChild(clone);
        }
    }

    function toNavBack() {
        L.toggle('#toNavLink', '#toNavBackLink');
        if(window.lastNav && window.lastNav != '#tabNav') {
            toTab(window.lastNav);
        } else {
            toTab('#tabBasic');
        }
    }

    function getCurrentTabId() {
        if(L('.tabs-pane.active')[0]) {
            var id = parseTabId(L('.tabs-pane.active')[0].baseURI);
        }
        return id ? id : parseTabId(window.location.href);
    }

    function parseTabId(url) {
        return url.indexOf('#') > -1 ? url.substring(url.indexOf('#')) : '';
    }

    function cursorPosValueHandler(data) {
        var x = data[flip.LIVE_MOV_X];
        var y = data[flip.LIVE_MOV_Y];
        var maxX = data[flip.LIVE_MOV_X_MAX];
        var maxY = data[flip.LIVE_MOV_Y_MAX];
        var minX = data[flip.LIVE_MOV_X_MIN];
        var minY = data[flip.LIVE_MOV_Y_MIN];
        var cursorPosVal = parseInt(L('#cursorPosVal').innerHTML);
        var deadX = flip.getConfig(flip.DEADZONE_X);
        var deadY = flip.getConfig(flip.DEADZONE_Y);
        var maxAbs = Math.max(maxX, maxY, Math.abs(minX), Math.abs(minY), cursorPosVal, Math.round(deadX*1.1), Math.round(deadY*1.1));
        var percentageX = (L.getPercentage(x, -maxAbs, maxAbs));
        var percentageY = (L.getPercentage(y, -maxAbs, maxAbs));
        var percentageDzX = (L.getPercentage(flip.getConfig(flip.DEADZONE_X), 0, maxAbs));
        var percentageDzY = (L.getPercentage(flip.getConfig(flip.DEADZONE_Y), 0, maxAbs));
        var inDeadzone = x < flip.getConfig(flip.DEADZONE_X) && x > -flip.getConfig(flip.DEADZONE_X) &&
            y < flip.getConfig(flip.DEADZONE_Y) && y > -flip.getConfig(flip.DEADZONE_Y);

        L('#cursorPos').style = 'top: ' + percentageY + '%; left: ' + percentageX + '%;';
        L('#cursorPosVal').innerHTML = maxAbs;
        L('#deadZonePos').style = 'top: ' + (100 - percentageDzY) / 2 + '%; left: ' + (100 - percentageDzX) / 2 + '%; height: ' + (percentageDzY) + '%; width: ' + (percentageDzX) + '%;';
        L('#deadZonePos').className = 'back-layer color-' + (inDeadzone ? 'lightcyan' : 'lightercyan');
        L('#orientationSign').style = 'transform: rotate(' + (flip.getConfig(flip.ORIENTATION_ANGLE)+90)%360 + 'deg);';
    }

    function cursorPosZoomReset() {
        flip.resetMinMaxLiveValues();
        L('#cursorPosVal').innerHTML = 110;
    }

    function sipPuffValueHandler(data) {
        var min = data[flip.LIVE_PRESSURE_MIN];
        var max = data[flip.LIVE_PRESSURE_MAX];
        var val = data[flip.LIVE_PRESSURE];

        var border = 10; // space that is left and right of the min/max values on the sliders
        var currentMinRange = Math.max(Math.min(min - border, flip.getConfig(flip.SIP_THRESHOLD) - border, flip.getConfig(flip.SIP_STRONG_THRESHOLD) - border), 0);
        var currentMaxRange = Math.min(Math.max(max + border, flip.getConfig(flip.PUFF_THRESHOLD) + border, flip.getConfig(flip.PUFF_STRONG_THRESHOLD) + border), 1023);
        var percent = L.getPercentage(val, currentMinRange, currentMaxRange);
        var percentMin = L.getPercentage(min, currentMinRange, currentMaxRange);
        var percentMax = L.getPercentage(max, currentMinRange, currentMaxRange);

        L('#maxValue').innerHTML = max;
        L('#minValue').innerHTML = min;
        L('#currentValue').innerHTML = val;

        L('#guide-max').style = 'width: ' + percentMax + '%;';
        L('#guide-min').style = 'width: ' + percentMin + '%;';

        L('#sippuff-value-bar').style = 'width: ' + percent + '%;';
        L('#guide-current').style = 'width: ' + percent + '%;';

        //set slider ranges
        flip.SIP_PUFF_IDS.forEach(function (id) {
            L(id).min = currentMinRange;
            L(id).max = currentMaxRange;
        });
    }
</script>
</body>
</html>