<html>
<head>
    <title>FlipMouse WebGUI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link rel="stylesheet" href="css/tabby.min.css">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="stylesheet" href="css/rangeslider.css">
    <script src="lib/tabby.min.js"></script>
    <script src="lib/dom-i18n.min.js"></script>

    <script src="js/constants.js"></script>
    <script src="js/lquery.js"></script>
    <script src="js/areCommunicatorLight.js"></script>
    <script src="js/flipMouseCommunicator.js"></script>
    <script src="js/tabBasic.js"></script>
    <script src="js/tabSip.js"></script>
    <script src="js/tabSlot.js"></script>
    <script src="js/tabAction.js"></script>
</head>
<body>
<div id="content">
    <div class="row">
        <div>
            <h1 class="nine columns" i18n>FLipMouse Configuration // FLipMouse Konfiguration</h1>
            <span class="show-mobile headerConnectIndicator green connectedIndicator" style="display: none">&#x2713;</span>
            <span class="show-mobile headerConnectIndicator red disconnectedIndicator">&#x2717;</span>
        </div>
        <div class="three columns hide-mobile">
            <div class="row">
                <label class="seven columns" for="selectSlots" i18n>Select Slot // Slot auswählen</label>
                <div class="five columns text-right connectedIndicator" style="display: none">
                    <span style="color: green">&#x2713;</span>
                    <span class="show-desktop">connected</span>
                </div>
                <div class="five columns text-right disconnectedIndicator">
                    <span style="color: red">&#x2717;</span>
                    <span class="show-desktop">not connected</span>
                </div>
            </div>
            <select id="selectSlots" class="slot-select row u-full-width" onchange="tabSlot.selectSlot(this)">
            </select>
        </div>
    </div>
    <div class="row hide-mobile" style="margin-bottom: 1.5em"></div>

    <div data-tabs class="row" id="tabMenu">
        <div class="three columns hide-mobile"><a onclick="toTab(this.href)" class="button button-primary" data-tab href="#tabBasic" class="ui-btn-active" i18n>Basic Setup // Basis-Konfiguration</a></div>
        <div class="three columns hide-mobile"><a onclick="toTab(this.href)" class="button button-primary" data-tab href="#tabPuff" i18n>Sip and Puff // Saug-Blassteuerung</a></div>
        <div class="three columns hide-mobile"><a onclick="toTab(this.href)" class="button button-primary" data-tab href="#tabSlots" i18n>Slot configuration // Slot-Konfiguration</a></div>
        <div class="three columns hide-mobile"><a onclick="toTab(this.href)" class="button button-primary" data-tab href="#tabActions" i18n>Action configuration // Konfiguration Aktionen</a></div>
        <div class="show-mobile"><a id="toNavLink" onclick="toNav()" class="button button-primary" data-tab href="#tabNav" i18n>&#x2630; Menu // &#x2630; Menü</a></div>
        <div class="show-mobile"><a id="toNavBackLink" style="display: none" onclick="toNavBack()" class="button button-primary" i18n>&#8592; Back // &#8592; Zurück</a></div>
    </div>
    <div data-tabs-content>
        <div data-tabs-pane class="tabs-pane" id="tabNav">
            <div id="tabNavContainer" class="row"></div>
        </div>
        <div data-tabs-pane class="tabs-pane" id="tabBasic">
            <div id="basic-SENSITIVITY-single">
                <label for="SENSITIVITY" i18n>Sensitivity: // Sensitivität:</label>
                <a class="u-pull-right" href="javascript:tabBasic.toggleShowXY('SENSITIVITY')" i18n>show x/y separately // zeige x/y getrennt</a>
                <div class="row">
                    <span id="SENSITIVITY_VAL" class="text-center one column">0</span>
                    <input type="range" oninput="tabBasic.basicSliderChanged(event)" onchange="tabBasic.basicSliderChanged(event)"
                           id="SENSITIVITY" min="0" max="255" class="eleven columns">
                </div>
            </div>
            <div id="basic-SENSITIVITY-xy" style="display: none">
                <label for="SENSITIVITY_X" i18n>Horizontal Sensitivity: // Sensitivität horizontal:</label>
                <a class="u-pull-right" href="javascript:tabBasic.toggleShowXY('SENSITIVITY')" i18n>hide separate x/y // zeige  x/y gemeinsam</a>
                <div class="row">
                    <span id="SENSITIVITY_X_VAL" class="text-center one column">0</span>
                    <input type="range" oninput="tabBasic.basicSliderChanged(event)" onchange="tabBasic.basicSliderChanged(event)"
                           id="SENSITIVITY_X" min="0" max="255" class="eleven columns">
                </div>
                <label for="SENSITIVITY_Y" i18n>Vertical Sensitivity: // Sensitivität vertikal:</label>
                <div class="row">
                    <span id="SENSITIVITY_Y_VAL" class="text-center one column">0</span>
                    <input type="range" oninput="tabBasic.basicSliderChanged(event)" onchange="tabBasic.basicSliderChanged(event)"
                           id="SENSITIVITY_Y" min="0" max="255" class="eleven columns">
                </div>
            </div>

            <br/>
            <div class="row">
                <div class="six columns">
                    <div class="relative center-div cursorPosWrapper">
                        <div id="orientationSign" class="back-layer full-height full-width" style="transform: rotate(270deg);">
                            <div class="back-layer" style="top:100%; left: 35%; width: 30%; height: 10%; background-color: black; z-index: 2"></div>
                        </div>
                        <div id="deadZonePos" class="back-layer color-lightcyan"
                             style="top: 40%; left: 40%; height: 20%; width: 20%;"></div>
                        <div class="back-layer"
                             style="left: 50%; height: 100%; border-right-style: solid; border-right-width: thin;"></div>
                        <div class="back-layer"
                             style="top: 50%; width: 100%; border-bottom-style: solid; border-bottom-width: thin;"></div>
                        <button onclick="tabBasic.cursorPosZoomReset();" class="zoombutton" style="top: 55%;" title="Reset Zoom">&#8634;</button>
                        <div id="cursorPosVal" class="back-layer" style="top: 40%;">110</div>
                        <div id="cursorPos" class="back-layer" style="top: 50%; left: 50%;">
                            <div class="back-layer" id="circle"></div>
                        </div>
                    </div>
                </div>
                <div class="five columns">
                    <button onclick="actionAndToggle(flip.calibrate, [], ['#basic-button-calibrate', '#basic-button-calibrating'])">
                        <span i18n id="basic-button-calibrate">Calibrate middle position // Mittelposition kalibrieren</span>
                        <span id="basic-button-calibrating" style="display: none;" i18n>Calibrating... // wird kalibriert...</span>
                    </button>
                    <button onclick="actionAndToggle(flip.rotate, [], ['#basic-button-rotate', '#basic-button-rotating'])">
                        <span i18n id="basic-button-rotate">&#x21bb; Rotate right // &#x21bb; Nach rechts drehen</span>
                        <span id="basic-button-rotating" style="display: none;" i18n>Rotating... // wird gedreht...</span>
                    </button>
                </div>
            </div>

            <br/>
            <div id="basic-DEADZONE-single">
                <label for="DEADZONE">Deadzone:</label>
                <a class="u-pull-right" href="javascript:tabBasic.toggleShowXY('DEADZONE')" i18n>show x/y separately // zeige x/y getrennt</a>
                <div class="row">
                    <span id="DEADZONE_VAL" class="text-center one column">0</span>
                    <input type="range" oninput="tabBasic.basicSliderChanged(event)" onchange="tabBasic.basicSliderChanged(event)"
                           id="DEADZONE" min="0" max="650" class="eleven columns">
                </div>
            </div>
            <div id="basic-DEADZONE-xy" style="display: none">
                <label for="DEADZONE_X">Horizontal Deadzone:</label>
                <a class="u-pull-right" href="javascript:tabBasic.toggleShowXY('DEADZONE')" i18n>hide separate x/y // zeige x/y gemeinsam</a>
                <div class="row">
                    <span id="DEADZONE_X_VAL" class="text-center one column">0</span>
                    <input type="range" oninput="tabBasic.basicSliderChanged(event)" onchange="tabBasic.basicSliderChanged(event)"
                           id="DEADZONE_X" min="0" max="650" class="eleven columns">
                </div>
                <label for="DEADZONE_Y">Vertical Deadzone:</label>
                <div class="row">
                    <span id="DEADZONE_Y_VAL" class="text-center one column">0</span>
                    <input type="range" oninput="tabBasic.basicSliderChanged(event)" onchange="tabBasic.basicSliderChanged(event)"
                           id="DEADZONE_Y" min="0" max="650" class="eleven columns">
                </div>
            </div>


            <br/>
            <br/>
            <div class="row">
                <button id="basic-button" onclick="actionAndToggle(flip.save, [], ['#basic-button-normal', '#basic-button-saving'], '#save-basic-value-bar')" class="one-third" style="position: relative;">
                    <div id="save-basic-value-bar" class="value-bar color-lightercyan" style="width: 0%;"></div>
                    <div id="basic-button-normal" i18n>Save // Speichern</div>
                    <div id="basic-button-saving" style="display: none;" i18n>Saving... // Wird
                        gespeichert...
                    </div>
                </button>
            </div>
        </div>
        <div data-tabs-pane class="tabs-pane" id="tabPuff">

            <div id="tab-puff-container" class="relative">

                <div class="row back-layer full-height full-width">
                    <div class="two columns"><span style="font-size: 1px; color: transparent">_</span></div>
                    <div class="ten columns full-height relative">
                        <div id="guide-current" class="back-layer full-height border-right-gray"
                             style="width: 50%;"></div>
                        <div id="guide-max" class="back-layer full-height border-right-red" style="width: 50%;"></div>
                        <div id="guide-min" class="back-layer full-height border-right-blue" style="width: 50%;"></div>
                    </div>
                </div>

                <br/>
                <label for="SIP_THRESHOLD" i18n>Sip Threshold: // Schwellenwert Saugen:</label>
                <div class="row">
                    <span id="SIP_THRESHOLD_VAL" class="text-center two columns">0</span>
                    <input type="range" oninput="tabSip.sipSliderChanged(this)" onchange="tabSip.sipSliderChanged(this)"
                           id="SIP_THRESHOLD" min="0" max="1023" class="ten columns"/>
                </div>
                <label for="SIP_STRONG_THRESHOLD" i18n>Strong Sip Threshold: // Schwellenwert Saugen
                    stark:</label>
                <div class="row">
                    <span id="SIP_STRONG_THRESHOLD_VAL" class="text-center two columns">0</span>
                    <input type="range" oninput="tabSip.sipSliderChanged(this)" onchange="tabSip.sipSliderChanged(this)"
                           id="SIP_STRONG_THRESHOLD" min="0" max="1023" class="ten columns"/>
                </div>

                <br/>
                <label for="value-bar-wrapper" i18n>Live values: // Aktuelle Werte:</label>
                <div class="row">
                    <div id="value-bar-wrapper" class="text-center two columns">
                        <span i18n>current: // aktuell:</span><span id="currentValue">0</span>,
                        <span>max:</span><span id="maxValue">0</span>,
                        <span>min:</span><span id="minValue">-1</span></div>
                    <div class="ten columns"
                         style="position:relative; height: 2em; border-style: solid; border-width: thin; background-color: transparent">
                        <div id="sippuff-value-bar" class="value-bar" style="width: 50%;"></div>
                    </div>
                </div>

                <br/>
                <br/>
                <label for="PUFF_THRESHOLD" i18n>Puff Threshold: // Schwellenwert Blasen:</label>
                <div class="row">
                    <span id="PUFF_THRESHOLD_VAL" class="text-center two columns">0</span>
                    <input type="range" oninput="tabSip.sipSliderChanged(this)" onchange="tabSip.sipSliderChanged(this)"
                           id="PUFF_THRESHOLD" min="0" max="1023" class="ten columns">
                </div>
                <label for="PUFF_STRONG_THRESHOLD" i18n>Strong Puff Threshold: // Schwellenwert Blasen
                    stark:</label>
                <div class="row">
                    <span id="PUFF_STRONG_THRESHOLD_VAL" class="text-center two columns">0</span>
                    <input type="range" oninput="tabSip.sipSliderChanged(this)" onchange="tabSip.sipSliderChanged(this)"
                           id="PUFF_STRONG_THRESHOLD" min="0" max="1023" class="ten columns">
                </div>
            </div>

            <br/>
            <br/>
            <button id="sip-puff-button" onclick="actionAndToggle(flip.save, [], ['#sip-puff-button-normal', '#sip-puff-button-saving'], '#save-sip-value-bar')" class="u-full-width" style="position: relative;">
                <div id="save-sip-value-bar" class="value-bar color-lightercyan" style="width: 0%;"></div>
                <div id="sip-puff-button-normal" style="position: relative" i18n>Save // Speichern</div>
                <div id="sip-puff-button-saving" style="display: none" i18n>Saving... // Wird
                    gespeichert...
                </div>
            </button>
        </div>
        <div data-tabs-pane class="tabs-pane" id="tabSlots">
            <div class="row">
                <label for="selectSlots2" i18n>Select active slot // Aktiven Slot auswählen</label>
                <select id="selectSlots2" class="slot-select u-full-width" onchange="tabSlot.selectSlot(this)">
                </select>
            </div>

            <br/>
            <div class="row">
                <label for="newSlotLabel" i18n>Create new slot // Neuen Slot anlegen</label>
                <div i18n class="u-full-width">
                    <input id="newSlotLabel" oninput="tabSlot.saveSlotLabelChanged(this)" type="text" class="u-full-width" placeholder="<insert name for new slot>" maxlength="15"/>
                    <input id="newSlotLabel" oninput="tabSlot.saveSlotLabelChanged(this)" type="text" class="u-full-width" placeholder="<Name für neuen Slot eingeben>" maxlength="15"/>
                </div>
                <button id="create-slot-button" disabled onclick="tabSlot.createSlot(['#create-slot-button-normal', '#create-slot-button-saving'], '#create-slot-value-bar')" class="u-full-width" style="position: relative;">
                    <div id="create-slot-value-bar" class="value-bar color-lightercyan" style="width: 0%;"></div>
                    <div id="create-slot-button-normal" style="position: relative" i18n>Create Slot // Slot anlegen</div>
                    <div id="create-slot-button-saving" style="display: none" i18n>creating slot... // Slot wird anlgelegt...</div>
                </button>
            </div>

            <br/>
            <div class="row">
                <label for="selectSlotDelete" i18n>Delete Slot // Slot löschen</label>
                <select id="selectSlotDelete" class="slot-select u-full-width">
                </select>
                <button id="delete-slot-button" onclick="tabSlot.deleteSlot(['#delete-slot-button-normal', '#delete-slot-button-saving'], '#delete-slot-value-bar')" class="u-full-width" style="position: relative;">
                    <div id="delete-slot-value-bar" class="value-bar color-lightercyan" style="width: 0%;"></div>
                    <div id="delete-slot-button-normal" style="position: relative" i18n>Delete Slot // Slot löschen</div>
                    <div id="delete-slot-button-saving" style="display: none" i18n>deleting slot... // Slot wird gelöscht...</div>
                </button>
            </div>

            <br/>
            <div class="row">
                <label for="selectSlotDelete" i18n>Reset to default configuration // Rücksetzen auf Defaulteinstellungen</label>
                <button id="reset-slot-button" onclick="tabSlot.resetConfig(['#reset-slot-button-normal', '#reset-slot-button-saving'], '#reset-slot-value-bar')" class="u-full-width" style="position: relative;">
                    <div id="reset-slot-value-bar" class="value-bar color-lightercyan" style="width: 0%;"></div>
                    <div id="reset-slot-button-normal" style="position: relative" i18n>Reset // Zurücksetzen</div>
                    <div id="reset-slot-button-saving" style="display: none" i18n>Resetting... // Wird zurückgesetzt...</div>
                </button>
            </div>
        </div>
        <div data-tabs-pane class="tabs-pane" id="tabActions">
            <label i18n>Change actions // Aktionen ändern</label>
            <div id="pressedKey">
                <div class="row">
                    <label class="three columns text-right text-normal" i18n>Action to define // Zu belegende Funktion</label>
                    <select id="selectActionButton" class="eight columns" onchange="tabAction.selectActionButton(this.value)">
                    </select>
                </div>
                <div class="row" style="display: none">
                    <label class="three columns text-right text-normal" i18n>Action category // Aktions-Kategorie</label>
                    <select id="selectActionCategory" class="eight columns" disabled="true">
                    </select>
                </div>
                <div class="row" style="display: none">
                    <label class="three columns text-right text-normal" i18n>Action // Aktion</label>
                    <select id="selectAction" class="eight columns" disabled="true">
                    </select>
                </div>

                <div class="row">
                    <label class="three columns"></label>
                    <button id="start-rec-button" onclick="actionAndToggle(tabAction.startRec, [], ['#start-rec-button-normal', '#start-rec-button-rec'])" class="eight columns" style="position: relative;">
                        <div id="start-rec-button-normal" style="position: relative" i18n>Start recording actions // Aufnahme Aktionen starten</div>
                        <div id="start-rec-button-rec" style="display: none" i18n>Now press keys to record... (click here to stop) // Jetzt Tasten zum Aufnehmen drücken... (zum Stoppen klicken)</div>
                    </button>
                </div>

                <div class="row">
                    <label class="three columns text-right text-normal" i18n>Recorded Action // Aufgenommene Aktion</label>
                    <span id="recordedAction" style="font-weight: bold" class="eight columns"/>
                </div>
                <div class="row">
                    <label class="three columns text-right text-normal" i18n>Recorded AT Command // Aufgenommenes AT Kommando</label>
                    <span id="recordedAtCmd" class="eight columns"/>
                </div>
            </div>
            <label i18n>Current mapping // Aktuelle Konfiguration</label>
            <div id="currentConfigTh" class="hide-mobile row thead" aria-hidden="true">
                <div class="two columns" i18n>Description // Bezeichnung</div>
                <div class="eight columns" i18n>Current action // aktuelle Aktion</div>
            </div>
            <ol id="currentConfigTb" class="tbody"></ol>
        </div>
    </div>
</div>

<script>
    window.onload = function () {
        tabby.init();
        domI18n({
            selector: '[i18n]',
            separator: ' // ',
            languages: ['en', 'de']
        });
        var flip = new FlipMouse(function (config) {
            initWithConfig(config);
            initSlots();
            toTab(getCurrentTabId());
            testConnection();
            setInterval(function () {
                testConnection();
            }, 10000);
            function testConnection() {
                flip.testConnection(true).then(function (isConnected) {
                    L.setVisible('.connectedIndicator', isConnected);
                    L.setVisible('.disconnectedIndicator', !isConnected);
                });
            }
        });
        window.flip = flip;
    };

    function initWithConfig(config) {
        console.log('applying config:');
        console.log(config);
        if(!config) {
            return;
        }
        setSliderValue(flip.SENSITIVITY_X, config[flip.SENSITIVITY_X]);
        setSliderValue(flip.SENSITIVITY_Y, config[flip.SENSITIVITY_Y]);
        setSliderValue('SENSITIVITY', config[flip.SENSITIVITY_X]);
        setSliderValue(flip.DEADZONE_X, config[flip.DEADZONE_X]);
        setSliderValue(flip.DEADZONE_Y, config[flip.DEADZONE_Y]);
        setSliderValue('DEADZONE', config[flip.DEADZONE_X]);
        setSliderValue(flip.SIP_THRESHOLD, config[flip.SIP_THRESHOLD]);
        setSliderValue(flip.SIP_STRONG_THRESHOLD, config[flip.SIP_STRONG_THRESHOLD]);
        setSliderValue(flip.PUFF_THRESHOLD, config[flip.PUFF_THRESHOLD]);
        setSliderValue(flip.PUFF_STRONG_THRESHOLD, config[flip.PUFF_STRONG_THRESHOLD]);

        if (config[flip.SENSITIVITY_X] != config[flip.SENSITIVITY_Y]) {
            tabBasic.toggleShowXY('SENSITIVITY');
        }
        if (config[flip.DEADZONE_X] != config[flip.DEADZONE_Y]) {
            tabBasic.toggleShowXY('DEADZONE');
        }
    }

    function initSlots() {
        var slots = flip.getSlots();
        L('#delete-slot-button').disabled = slots.length <= 1;
        L('#create-slot-button').disabled = true;
        L.removeAllChildren('.slot-select');
        slots.forEach(function (slot) {
            var option = document.createElement("option");
            option.value = slot;
            option.innerHTML = slot;
            L('.slot-select').forEach(function (elem) {
                elem.appendChild(option.cloneNode(true));
                elem.value = flip.getCurrentSlot();
            });
        });
    }

    function setSliderValue(constant, value, dontSetSlider) {
        L('#' + constant + '_VAL').innerHTML = value;
        if (!dontSetSlider) {
            L('#' + constant).value = value;
        }
    }

    function actionAndToggle(actionFunction, argList, toggleElementList, progressBarId) {
        return new Promise(function (resolve) {
            var maxProgress = 0;
            var stopProgressBar = false;
            argList = argList || [];
            L.toggle.apply(null, toggleElementList);
            var promise = actionFunction.apply(null, argList.concat(progressHandler));
            if (promise && promise.then) {
                promise.then(function () {
                    if (progressBarId) {
                        progressHandler(100, 100);
                        setTimeout(function () {
                            stopProgressBar = true;
                            L(progressBarId).style = 'width: 0%;';
                        }, 500);
                    }
                    L.toggle.apply(null, toggleElementList);
                    resolve();
                }, function () {
                    stopProgressBar = true;
                });
            }

            function progressHandler(progress, timeConstant) {
                var startTime = L.getMs();
                timeConstant = timeConstant || 1000;
                if (progressBarId) {
                    updateProgressBar(maxProgress);
                }

                function updateProgressBar(oldPrg) {
                    setTimeout(function () {
                        var t = L.getMs() - startTime;
                        var p = (progress - oldPrg) * (1 - Math.exp(-t / timeConstant)) + oldPrg;
                        if (p > maxProgress && !stopProgressBar) {
                            maxProgress = p;
                            L(progressBarId).style = 'width: ' + p + '%;';
                            updateProgressBar(oldPrg);
                        }
                    }, 50);
                }
            }
        });
    }

    function toTab(tabId) {
        tabId = parseTabId(tabId);
        if(!tabId) {
            tabId = '#tabBasic';
        }
        tabby.toggleTab(tabId);
        L.setVisible('#toNavLink');
        L.setVisible('#toNavBackLink', false);
        if (tabId.indexOf('#tabBasic') > -1) {
            toBasic();
        } else if (tabId.indexOf('#tabPuff') > -1) {
            toSipPuff();
        } else if (tabId.indexOf('#tabSlots') > -1) {
            toSlots();
        } else if (tabId.indexOf('#tabActions') > -1) {
            toActions();
        } else if (tabId.indexOf('#tabNav') > -1) {
            toNav();
        }
    }
    
    function toBasic() {
        flip.startLiveValueListener(tabBasic.cursorPosValueHandler);
    }

    function toSipPuff() {
        flip.startLiveValueListener(tabSip.sipPuffValueHandler);
    }

    function toSlots() {
        flip.stopLiveValueListener();
    }

    function toActions() {
        flip.stopLiveValueListener();
        tabAction.initBtnModeActionTable();
        tabAction.initCombos();
    }

    function toNav() {
        tabby.toggleTab('#tabNav');
        L.toggle('#toNavLink', '#toNavBackLink');
        window.lastNav = getCurrentTabId();

        var tabNav = L('#tabNavContainer');
        if(tabNav.hasChildNodes()) {
            return;
        }
        var navItems = L('#tabMenu').children;
        for (var i = 0; i < navItems.length-2; i++) {
            var clone = navItems[i].cloneNode(true);
            clone.className = '';
            tabNav.appendChild(clone);
        }
    }

    function toNavBack() {
        L.toggle('#toNavLink', '#toNavBackLink');
        if(window.lastNav && window.lastNav != '#tabNav') {
            toTab(window.lastNav);
        } else {
            toTab('#tabBasic');
        }
    }

    function getCurrentTabId() {
        if(L('.tabs-pane.active')[0]) {
            var id = parseTabId(L('.tabs-pane.active')[0].baseURI);
        }
        return id ? id : parseTabId(window.location.href);
    }

    function parseTabId(url) {
        return url.indexOf('#') > -1 ? url.substring(url.indexOf('#')) : '';
    }
</script>
</body>
</html>